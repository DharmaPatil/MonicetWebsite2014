<?php


/**
 * Skeleton subclass for performing query and update operations on the 'mf_log' table.
 *
 * 
 *
 * This class was autogenerated by Propel 1.4.1 on:
 *
 * Tue Feb 16 11:06:43 2010
 *
 * You should add additional methods to this class to meet the
 * application requirements.  This class will only be generated as
 * long as it does not already exist in the output directory.
 *
 * @package    plugins.mfLogPlugin.lib.model
 */
class mfLogPeer extends BasemfLogPeer {
	const INFO='info';  // informação genérica sobre um acontecimento para que fique o registo
	const NOTICE='notice'; // informação genérica com o potencial de verificar se está correcto
	const DEBUG='debug'; // alerta durante a fase de desenvolvimento, deverá posteriormente passar a info ou notice
	const WARNING='warning'; // alerta de erro não fatal
	const ERROR='error'; // alerta de erro fatal, deverá ser gerada uma entrada sempre que algo ocorrer mal na aplicação
	
	private static $tipos = array('info', 'warning', 'notice', 'debug', 'error');
	
  public static function log($mensagem, $tipo = 'info')
  {
    $log = new mfLog();
    $log->setMensagem($mensagem);
    $log->setTipo($tipo);
    $log->save();
    
    return $log;
  }
  
  public static function getTipos()
  {
  	return self::$tipos;
  }
  
  public static function excepcao(sfEvent $evento)
  {
  	$excepcao = $evento->getSubject();
  	$contexto = sfContext::getInstance();

  	$mensagem = ! is_null($excepcao->getMessage()) ? $excepcao->getMessage() : '-';
    $modulo = $contexto->getModuleName();
    $accao = $contexto->getActionName();
    $uri = $contexto->getRequest()->getUri();
    
    $mensagem = sprintf('Ocorreu a seguinte excepção: "%s" no módulo "%s" e acção "%s" no endereço "%s".', $mensagem, $modulo, $accao, $uri);
    
    self::log($mensagem, self::ERROR);
    
    if ( sfConfig::get('app_mfLog_email', false) ){
    	$mailer = $contexto->getMailer()->composeAndSend(
        sfConfig::get('app_mfLog_email_from'),
        sfConfig::get('app_mfLog_email_to'),
        sfConfig::get('app_mfLog_email_assunto', 'Ocorreu uma excepção'),
        $mensagem
    	);
    } 
  }
}